<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>3. Rcpp basics - SC2</title>
    <meta property="og:title" content="3. Rcpp basics - SC2">
    
    <meta name="twitter:card" content="summary">

    
      
    

    
      
    

    
    

    

    
    


<link href='//cdn.bootcss.com/highlight.js/9.12.0/styles/github.min.css' rel='stylesheet' type='text/css' />



    <link rel="stylesheet" href="/sc2-2019/css/style.css" />
    <link rel="stylesheet" href="/sc2-2019/css/fonts.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Arvo">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Marcellus">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro">

<link rel="stylesheet" href="/sc2-2019/css/custom.css" />

<link rel="icon" href="/sc1-2019/favicon.ico" type="image/x-icon" />























<nav class="breadcrumbs">
    
        <a href="https://mfasiolo.github.io/sc2-2019/">home / </a>
    
        <a href="https://mfasiolo.github.io/sc2-2019/rcpp_advanced_ii/">rcpp_advanced_ii / </a>
    
        <a href="https://mfasiolo.github.io/sc2-2019/rcpp_advanced_ii/junk/">junk / </a>
    
</nav>

  </head>

  
  <body class="sc2-2019">
    <header class="masthead">
      <h1><a href="/sc2-2019/">SC2</a></h1>

<p class="tagline">Statistical Computing 2</p>

      <nav class="menu">
  <input id="menu-check" type="checkbox" />
  <label id="menu-label" for="menu-check" class="unselectable">
    <span class="icon close-icon">✕</span>
    <span class="icon open-icon">☰</span>
    <span class="text">Menu</span>
  </label>
  <ul>
  
  
  <li><a href="/sc2-2019/">Home</a></li>
  
  <li><a href="/sc2-2019/rcpp/">Integrating R and C</a></li>
  
  <li><a href="/sc2-2019/rcpp_advanced_i/">Advanced Rcpp I</a></li>
  
  <li><a href="/sc2-2019/rcpp_advanced_ii/">Advanced Rcpp II</a></li>
  
  
  </ul>
</nav>

    </header>

    <article class="main">
      <header class="title">
      
<h1>3. Rcpp basics</h1>

<h3>
</h3>
<hr>


      </header>





<div id="TOC">
<ul>
<li><a href="#rcpp-via-r-cmd-shlib-the-old-but-instructive-way">Rcpp via R CMD SHLIB: the old but instructive way</a></li>
</ul>
</div>

<style>
body {
text-align: justify}
</style>
<div id="rcpp-via-r-cmd-shlib-the-old-but-instructive-way" class="section level3">
<h3>Rcpp via R CMD SHLIB: the old but instructive way</h3>
<!-- Plan:  -->
<!--     - Ricker Simul in Rcpp -->
<!--     - Ricker llk in Rcpp -->
<!--     - Gradient Descent in Rcpp -->
<!--     - Cancellation error in finite differences -->
<!--     - Step-length control -->
<!-- ```{r} -->
<!-- rickerSimul <- function(n, r){ -->
<!--  y0 <- 1 -->
<!--  y <- numeric(n) -->
<!--  yx <- y0 -->
<!--  # Simulating and storing -->
<!--  for(ii in 1:n){ -->
<!--   yx <- r * yx * exp(-yx) -->
<!--   y[ii] <- yx -->
<!--  } -->
<!--  return( y ) -->
<!-- } -->
<!-- llk <- function(logr, logsig){  -->
<!--  ymod <- rickerSimul(n = n, r = exp(logr)) -->
<!--  out <- sum( dnorm(log(yobs) - log(ymod), 0, exp(logsig), log = TRUE) ) -->
<!--  return( out ) -->
<!-- } -->
<!-- set.seed(986) -->
<!-- n <- 100 -->
<!-- y0_true <- 1 -->
<!-- sig_true <- 0.2 -->
<!-- r_true <- 7 -->
<!-- Ntrue <- rickerSimul(n = n, r = r_true) -->
<!-- yobs <- Ntrue * exp(rnorm(n, 0, sig_true)) -->
<!-- plot(yobs, type = 'b') -->
<!-- sig_seq <- seq(0.05, 0.8, length.out = 100) -->
<!-- plot(sig_seq, sapply(sig_seq, function(.x) llk(logr = log(r_true), logsig = log(.x)))) -->
<!-- abline(v = sig_true) -->
<!-- r_seq <- seq(5, 20, length.out = 100) -->
<!-- plot(r_seq, sapply(r_seq, function(.x) llk(logr = log(.x), logsig = log(sig_true)))) -->
<!-- abline(v = r_true) -->
<!-- gradFD <- function(lr, ls, h){ -->
<!--   out <- c(llk(lr + h, ls) - llk(lr, ls),  -->
<!--            llk(lr, ls + h) - llk(lr, ls)) / h -->
<!--   return( out ) -->
<!-- } -->
<!-- init <- par_hat <- c(log(8.5), log(0.15)) -->
<!-- traj <- matrix(NA, 1000, 2) -->
<!-- for(ii in 1:1000){ -->
<!--   par_hat <- par_hat + 1e-5 * gradFD(par_hat[1], par_hat[2], h = 1e-4) -->
<!--   traj[ii, ] <- par_hat -->
<!-- } -->
<!-- niter <- 100 -->
<!-- init <- par_hat <- par_old <- c(log(8.5), log(0.15)) -->
<!-- traj <- matrix(NA, niter, 2) -->
<!-- traj[1, ] <- init -->
<!-- for(ii in 2:niter){ -->
<!--   bad_step <- TRUE -->
<!--   eps <- 1e-4 -->
<!--   grad <- gradFD(par_hat[1], par_hat[2], h = 1e-6) -->
<!--   kk <- 1 -->
<!--   while(bad_step && kk < 10){ -->
<!--    par_hat <- par_old + eps  * grad -->
<!--    bad_step <- (llk(par_hat[1], par_hat[2]) - llk(par_old[1], par_old[2])) < 0 -->
<!--    eps <- eps / 2 -->
<!--    kk <- kk+1 -->
<!--   } -->
<!--   par_old <- par_hat -->
<!--   traj[ii, ] <- par_hat -->
<!-- } -->
<!-- lr_grid <- seq(log(5), log(9), length.out = 100) -->
<!-- ls_grid <- seq(log(0.1), log(0.5), length.out = 100) -->
<!-- grd <- expand.grid(lr_grid,ls_grid) -->
<!-- llk_grid <- apply(grd, 1, function(.par) llk(.par[1], .par[2])) -->
<!-- library(ggplot2) -->
<!-- ggplot(data = data.frame(logr = grd[ , 1], logsig = grd[ , 2], z = llk_grid),  -->
<!--        mapping = aes(x = logr, y = logsig, z = z, fill = z)) + geom_raster() + geom_contour(bins = 20) +  -->
<!--        geom_vline(xintercept=log(r_true)) + geom_hline(yintercept=log(sig_true)) +  -->
<!--        geom_path(data = data.frame(logr = traj[ , 1], logsig = traj[ , 2]),  -->
<!--                  mapping = aes(x=logr, y=logsig), colour = "red",  -->
<!--                  inherit.aes = FALSE) -->
<!-- ``` -->
<pre class="r"><code># fObj &lt;- function(.x) .x^2
# 
# fGrad &lt;- function(.x, h = 1e-3) (fObj(.x+h) - fObj(.x)) / h
# 
# x0 &lt;- x1 &lt;- 2
# xSeq1 &lt;- numeric(500)
# 
# for(ii in 1:500){
#   x1 &lt;- x0 - 0.01 * fGrad(x0)
#   x0 &lt;- x1
#   xSeq1[ii] &lt;- x1  
# }
# 
# x0 &lt;- x1 &lt;- 2
# xSeq2 &lt;- numeric(500)
# 
# for(ii in 1:500){
#   x1 &lt;- x0 - 0.01 * fGrad(x0, h = 1e-15)
#   x0 &lt;- x1
#   xSeq2[ii] &lt;- x1  
# }
# 
# 
# plot(xSeq, fObj(xSeq))
# lines(xSeq2, fObj(xSeq2), col = 2)
# 
# 
# n &lt;- 1e3
# 
# sd &lt;- 1e17
# x &lt;- rnorm(n, 0, sd*0.71)
# 
# plot(dnorm(x, 0, sd)/(dnorm(x, 0, sd*0.71)))
# 
# mean(dnorm(x, 0, sd)/(dnorm(x, 0, sd*0.71)))
# 
# mean(dnorm(x, 0, sd)/(dnorm(x, 0, sd+1)))
# 
# x &lt;- rnorm(n, 0, 1)
# 
# 
# 
# xseq &lt;- seq(-3, 3, length.out = 100)
# 
# fHat &lt;- sapply(xseq, function(.x) mean(dnorm(.x, x, 0.0001)))
# 
# plot(xseq, fHat, type = &#39;l&#39;)</code></pre>
<!-- See -->
<!-- Rcpp manual -->
<!-- http://adv-r.had.co.nz/C-interface.html -->
<!-- https://github.com/hadley/r-internals -->
<!-- https://cran.r-project.org/doc/manuals/r-release/R-ints.html -->
<!-- https://cran.r-project.org/doc/manuals/R-exts.html -->
</div>


  <footer>
  

<script src="//yihui.name/js/math-code.js"></script>
<script async src="//mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>

<script async src="//yihui.name/js/center-img.js"></script>


<script type="text/javascript">
var sc_project=12110974;
var sc_invisible=1;
var sc_security="9b171880";
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js"
async></script>
<noscript><div class="statcounter"><a title="Web Analytics"
href="https://statcounter.com/" target="_blank"><img
class="statcounter"
src="https://c.statcounter.com/12110974/0/9b171880/1/"
alt="Web Analytics"></a></div></noscript>








  


<p align=right>

<a href='https://github.com/mfasiolo/sc2-2019/blob/master/content/rcpp_advanced_II/junk.Rmd'>View source</a>

|

<a href='https://github.com/mfasiolo/sc2-2019/edit/master/content/rcpp_advanced_II/junk.Rmd'>Edit source</a>

</p>





<script src="https://utteranc.es/client.js"
        repo="awllee/sc1-2019"
        issue-term="pathname"
        label="utterance"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>



  



<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>



<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/r.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/yaml.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/tex.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



  
  <hr>
  <div class="copyright">© 2019 <a href="https://mfasiolo.github.io/">Matteo Fasiolo</a></div>
  
  </footer>
  </article>
  
  </body>
</html>

